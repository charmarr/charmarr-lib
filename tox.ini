# Copyright 2025 The Charmarr Project
# See LICENSE file for licensing details.

[tox]
no_package = True
skip_missing_interpreters = True
env_list = lint, static, unit
min_version = 4.0.0

[vars]
# Source paths for all packages
core_src = {tox_root}/core/src
vpn_src = {tox_root}/vpn/src
krm_src = {tox_root}/krm/src
testing_src = {tox_root}/testing/src
all_src = {[vars]core_src} {[vars]vpn_src} {[vars]krm_src} {[vars]testing_src}

# Test paths for all packages
core_tests = {tox_root}/core/tests/unit
vpn_tests = {tox_root}/vpn/tests/unit
krm_tests = {tox_root}/krm/tests/unit
testing_tests = {tox_root}/testing/tests/unit
all_tests = {[vars]core_tests} {[vars]vpn_tests} {[vars]krm_tests} {[vars]testing_tests}

# All paths for linting/formatting/type checking
all_path = {[vars]all_src} {[vars]all_tests}

# uv flags for consistent behavior
uv_flags = --frozen --isolated

[testenv]
allowlist_externals = uv
set_env =
    PYTHONBREAKPOINT=pdb.set_trace
    PY_COLORS=1

[testenv:lock]
description = Update uv.lock with the latest deps
commands =
    uv lock --upgrade --no-cache

[testenv:lint]
description = Lint the code with ruff
commands =
    uv run {[vars]uv_flags} ruff check {[vars]all_path}

[testenv:fmt]
description = Format the code with ruff
commands =
    uv run {[vars]uv_flags} ruff format {[vars]all_path}

[testenv:static]
description = Run static type checking with pyright
commands =
    uv run {[vars]uv_flags} pyright {[vars]all_path}

[testenv:unit]
description = Run unit tests for all packages with coverage
commands =
    uv run {[vars]uv_flags} coverage run --source=core/src/charmarr_lib,vpn/src/charmarr_lib,krm/src/charmarr_lib,testing/src/charmarr_lib \
        -m pytest {[vars]core_tests} {posargs}
    uv run {[vars]uv_flags} coverage run --append --source=core/src/charmarr_lib,vpn/src/charmarr_lib,krm/src/charmarr_lib,testing/src/charmarr_lib \
        -m pytest {[vars]vpn_tests} {posargs}
    uv run {[vars]uv_flags} coverage run --append --source=core/src/charmarr_lib,vpn/src/charmarr_lib,krm/src/charmarr_lib,testing/src/charmarr_lib \
        -m pytest {[vars]krm_tests} {posargs}
    uv run {[vars]uv_flags} coverage run --append --source=core/src/charmarr_lib,vpn/src/charmarr_lib,krm/src/charmarr_lib,testing/src/charmarr_lib \
        -m pytest {[vars]testing_tests} {posargs}
    uv run {[vars]uv_flags} coverage report

[testenv:unit-core]
description = Run unit tests for core package only
commands =
    uv run {[vars]uv_flags} pytest {[vars]core_tests} {posargs}

[testenv:unit-vpn]
description = Run unit tests for vpn package only
commands =
    uv run {[vars]uv_flags} pytest {[vars]vpn_tests} {posargs}

[testenv:unit-krm]
description = Run unit tests for krm package only
commands =
    uv run {[vars]uv_flags} pytest {[vars]krm_tests} {posargs}

[testenv:unit-testing]
description = Run unit tests for testing package only
commands =
    uv run {[vars]uv_flags} pytest {[vars]testing_tests} {posargs}

[testenv:coverage-html]
description = Generate HTML coverage report
commands =
    uv run {[vars]uv_flags} coverage run --source=core/src/charmarr_lib,vpn/src/charmarr_lib,krm/src/charmarr_lib,testing/src/charmarr_lib \
        -m pytest {[vars]all_tests}
    uv run {[vars]uv_flags} coverage report
    uv run {[vars]uv_flags} coverage html
